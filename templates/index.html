<!DOCTYPE html>
<html>
<head>
  <title>Spotify Chatbot Analyzer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="icon" type="image" sizes="16x16" href="\static\images\extract.png">
</head>
<body>
  <div class="container-fluid text-center">
  <h1 class="header">Music Analyser</h1>

<!-- Left White Aside -->
    <aside class="col-12 col-md-2 left-aside scroll-hidden d-none d-md-block">
      <img src="\static\images\music-file.png" alt="Music data">
    </aside>

<!-- Right White Aside -->
    <aside class="col-12 col-md-2 right-aside scroll-hidden d-none d-md-block">
      <img src="\static\images\music-file.png" alt="Music data">
    </aside>

  <div class="row justify-content-center align-items-start">

    
  <main class="col-12 col-md-8 chat-box position-relative">
    <!-- Loading GIF Overlay -->
<div id="loadingOverlay">
  <img src="{{ url_for('static', filename='images/SoundWaves.gif') }}" alt="Loading...">
</div>

    <div id="chat"></div>
    <input id="message" class="form-control mt-3" placeholder="Paste your Spotify Track or Album URL...">
    <button id="send" class="btn btn-success mt-2">Send</button>
  </div>

</div>
</main>

  <script>
  document.getElementById('send').onclick = async function() {
    const msg = document.getElementById('message').value;
    const chat = document.getElementById('chat');
    const sendBtn = document.getElementById('send');
    const loader = document.getElementById('loadingOverlay');

    if (!msg.trim()) return;

    // Display user message
    chat.innerHTML += `<div class="user">You: ${msg}</div>`;
    document.getElementById('message').value = '';

    // Show loader overlay
    loader.style.display = 'flex';
    sendBtn.disabled = true;

    // Wait 3 seconds before showing results
    setTimeout(async () => {
      try {
        const res = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: msg })
        });

        const data = await res.json();

        if (data.type === 'spotify_analysis') {
          chat.innerHTML += `
            <div class="bot">
              <b>Spotify Analysis:</b><br>
              <div class="table-container">
              ${data.table}
              <br>
              <img src="${data.graph_url}" alt="Graph" class="img-fluid mt-2" />
              <div class="mt-3">
  <button class="btn btn-outline-success btn-sm" onclick="downloadFile('${data.download_csv}', 'spotify_analysis.csv', 'text/csv')">
    ⬇ Download Table (CSV)
  </button>
  <button class="btn btn-outline-info btn-sm" onclick="downloadFile('${data.graph_url}', 'spotify_graph.png', 'image/png')">
    ⬇ Download Graph (PNG)
  </button>
</div>
            </div>
            </div>
          `;
        } else if (data.message) {
          chat.innerHTML += `<div class="bot">Bot: ${data.message}</div>`;
        } else if (data.error) {
          chat.innerHTML += `<div class="bot text-danger">Error: ${data.error}</div>`;
        }
      } catch (err) {
        chat.innerHTML += `<div class="bot text-danger">Error connecting to server.</div>`;
      }

      // Hide loader and enable button
      loader.style.display = 'none';
      sendBtn.disabled = false;
    }, 3000);
  };

async function downloadFile(url, filename, mimeType) {
  try {
    const response = await fetch(url);
    const blob = await response.blob();

    // Ensure correct MIME type
    const file = new Blob([blob], { type: mimeType });

    const link = document.createElement("a");
    link.href = URL.createObjectURL(file);
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  } catch (err) {
    alert("Error downloading file: " + err.message);
  }
}


  </script>

<!-- Bootstrap JS bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>  
</body>
</html>
